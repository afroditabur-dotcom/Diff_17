<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Тренажер по производным</title>
    <!-- Подключаем MathLive для визуального ввода (редактор формул) -->
    <script defer src="https://unpkg.com/mathlive"></script>
    <!-- Подключаем KaTeX для красивого отображения условий -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f9; padding: 20px; color: #333; }
        .card { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        
        /* Сетка выбора вариантов */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        
        /* Кнопки */
        .btn { 
            padding: 15px 20px; border: none; border-radius: 8px; cursor: pointer; 
            font-size: 16px; background: #3498db; color: white; transition: 0.3s;
            text-align: center;
        }
        .btn:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-check { background: #27ae60; width: 100%; margin-top: 20px; font-size: 18px; }
        .btn-check:hover { background: #219150; }

        /* Поле ввода MathLive */
        math-field {
            font-size: 24px; padding: 12px; border: 2px solid #ddd; border-radius: 8px;
            width: 100%; margin: 25px 0; background: #fff; outline: none;
        }
        math-field:focus-within { border-color: #3498db; box-shadow: 0 0 8px rgba(52,152,219,0.3); }

        .task-box { font-size: 36px; text-align: center; margin: 40px 0; min-height: 80px; }
        #progress { float: right; font-weight: bold; color: #7f8c8d; }
        .feedback { margin-top: 20px; padding: 20px; border-radius: 8px; text-align: center; font-size: 18px; }
        .correct { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .wrong { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .hidden { display: none; }
        
        .variant-title { font-size: 14px; display: block; opacity: 0.9; margin-top: 5px; }
    </style>
</head>
<body>

<!-- Экран выбора -->
<div class="card" id="start-screen">
    <h1>Тренажер: Производная функции</h1>
    <p style="text-align: center; color: #666; margin-bottom: 25px;">Выберите тему для тренировки. Для ввода используйте виртуальную клавиатуру (иконка справа в поле).</p>
    <div class="grid">
        <button class="btn" onclick="init(1)">Вариант 1 <span class="variant-title">Степенные функции</span></button>
        <button class="btn" onclick="init(2)">Вариант 2 <span class="variant-title">Тригонометрия и экспоненты</span></button>
        <button class="btn" onclick="init(3)">Вариант 3 <span class="variant-title">Произведение и частное</span></button>
        <button class="btn" onclick="init(4)">Вариант 4 <span class="variant-title">Сложные функции (цепное правило)</span></button>
        <button class="btn" onclick="init(5)">Вариант 5 <span class="variant-title">Корни и дроби</span></button>
        <button class="btn" onclick="init(6)">Вариант 6 <span class="variant-title">Итоговый микс</span></button>
    </div>
</div>

<!-- Экран теста -->
<div class="card hidden" id="test-screen">
    <div id="progress">1 / 5</div>
    <div style="clear: both;"></div>
    <div class="task-box" id="question-display"></div>
    
    <math-field id="ans-field" virtual-keyboard-mode="onfocus" placeholder="Введите производную..."></math-field>

    <button class="btn btn-check" id="action-btn" onclick="handleAction()">Проверить ответ</button>
    <div id="msg" class="feedback hidden"></div>
</div>

<!-- Экран результатов -->
<div class="card hidden" id="result-screen">
    <h1>Результат тренировки</h1>
    <div id="score-text" style="font-size: 28px; text-align: center; margin: 20px 0;"></div>
    <button class="btn" style="width: 100%" onclick="location.reload()">Вернуться к выбору тем</button>
</div>

<script>
// База данных заданий (6 вариантов)
const db = {
    1: [ // Степенные
        { q: "y = x^5", a: "5x^4" },
        { q: "y = 3x^2 + 7x", a: "6x+7" },
        { q: "y = x^3 - 4x + 10", a: "3x^2-4" },
        { q: "y = \\frac{1}{2}x^4", a: "2x^3" },
        { q: "y = x^{10} + x^2", a: "10x^9+2x" }
    ],
    2: [ // Тригонометрия и экспоненты
        { q: "y = \\sin x + x", a: "\\cos x + 1" },
        { q: "y = e^x + \\cos x", a: "e^x-\\sin x" },
        { q: "y = \\ln x - 5x", a: "\\frac{1}{x}-5" },
        { q: "y = 2^x", a: "2^x\\ln2" },
        { q: "y = \\tan x", a: "\\frac{1}{\\cos^2x}" }
    ],
    3: [ // Произведение и частное
        { q: "y = x \\cdot e^x", a: "e^x+xe^x" },
        { q: "y = x^2 \\sin x", a: "2x\\sin x+x^2\\cos x" },
        { q: "y = \\frac{x}{x+1}", a: "\\frac{1}{(x+1)^2}" },
        { q: "y = \\frac{e^x}{x}", a: "\\frac{xe^x-e^x}{x^2}" },
        { q: "y = x \\ln x", a: "\\ln x + 1" }
    ],
    4: [ // Сложные функции
        { q: "y = \\sin(2x)", a: "2\\cos(2x)" },
        { q: "y = e^{3x-1}", a: "3e^{3x-1}" },
        { q: "y = (2x+5)^{10}", a: "20(2x+5)^9" },
        { q: "y = \\ln(x^2 + 1)", a: "\\frac{2x}{x^2+1}" },
        { q: "y = \\cos^2x", a: "-2\\cos x \\sin x" }
    ],
    5: [ // Корни
        { q: "y = \\sqrt{x}", a: "\\frac{1}{2\\sqrt{x}}" },
        { q: "y = \\sqrt{2x+3}", a: "\\frac{1}{\\sqrt{2x+3}}" },
        { q: "y = \\frac{1}{x}", a: "-\\frac{1}{x^2}" },
        { q: "y = \\sqrt[3]{x}", a: "\\frac{1}{3\\sqrt[3]{x^2}}" },
        { q: "y = \\frac{5}{x^3}", a: "-\\frac{15}{x^4}" }
    ],
    6: [ // Микс
        { q: "y = e^{-x^2}", a: "-2xe^{-x^2}" },
        { q: "y = \\ln(\\sin x)", a: "\\frac{\\cos x}{\\sin x}" },
        { q: "y = x^2 e^{2x}", a: "2xe^{2x}+2x^2e^{2x}" },
        { q: "y = \\frac{\\sin x}{x}", a: "\\frac{x\\cos x - \\sin x}{x^2}" },
        { q: "y = \\sqrt{\\ln x}", a: "\\frac{1}{2x\\sqrt{\\ln x}}" }
    ]
};

let currentTasks = [], curIdx = 0, score = 0;
const mf = document.getElementById('ans-field');

function init(variantNum) {
    currentTasks = db[variantNum];
    curIdx = 0;
    score = 0;
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('test-screen').classList.remove('hidden');
    showTask();
}

function showTask() {
    const task = currentTasks[curIdx];
    document.getElementById('progress').innerText = `${curIdx + 1} / ${currentTasks.length}`;
    
    // Рендерим условие с помощью KaTeX
    katex.render(task.q, document.getElementById('question-display'), { 
        displayMode: true,
        throwOnError: false 
    });
    
    mf.value = ""; 
    document.getElementById('msg').classList.add('hidden');
    document.getElementById('action-btn').innerText = "Проверить ответ";
    document.getElementById('action-btn').className = "btn btn-check";
    
    // Фокус на поле ввода
    setTimeout(() => mf.focus(), 100);
}

// Очистка LaTeX для сравнения (убирает пробелы, скобки и т.д.)
function normalize(str) {
    return str
        .replace(/\\left/g, '').replace(/\\right/g, '')
        .replace(/\{/g, '').replace(/\}/g, '')
        .replace(/\s+/g, '')
        .replace(/\\cdot/g, '')
        .replace(/\(/g, '').replace(/\)/g, '')
        .replace(/\\mathrm/g, '');
}

function handleAction() {
    const btn = document.getElementById('action-btn');
    if (btn.innerText === "Проверить ответ") {
        check();
    } else {
        curIdx++;
        if (curIdx < currentTasks.length) {
            showTask();
        } else {
            finish();
        }
    }
}

function check() {
    const userAns = normalize(mf.value);
    const correctAns = normalize(currentTasks[curIdx].a);
    
    // Сравнение строк
    const isOk = (userAns === correctAns);
    if (isOk) score++;

    const m = document.getElementById('msg');
    m.innerHTML = isOk 
        ? "<b>Верно!</b>" 
        : `<b>Ошибка!</b> Правильный ответ: <span id="corr-view"></span>`;
    
    m.className = "feedback " + (isOk ? "correct" : "wrong");
    m.classList.remove('hidden');

    if (!isOk) {
        katex.render(currentTasks[curIdx].a, document.getElementById('corr-view'));
    }

    const btn = document.getElementById('action-btn');
    btn.innerText = "Следующий вопрос";
    btn.className = "btn"; // Меняем цвет на синий
}

function finish() {
    document.getElementById('test-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    document.getElementById('score-text').innerText = `Вы правильно решили ${score} из ${currentTasks.length} задач!`;
}
</script>

</body>
</html>
